name: Deploy Hundir la Flota

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      
name: Checkout repository
      uses: actions/checkout@v4

      # 2Ô∏è‚É£ Arrencar contenidors
      
name: Start Docker containers
      run: docker compose up -d

      # 3Ô∏è‚É£ Instal¬∑lar Ngrok
      
name: Install Ngrok
      run: |
        curl -sLo ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip
        unzip -o ngrok.zip
        sudo mv ngrok /usr/local/bin/
        sudo chmod +x /usr/local/bin/ngrok

      # 4Ô∏è‚É£ Autenticaci√≥ amb el secret NGROK_AUTHTOKEN
      
name: Authenticate Ngrok
      run: |
        ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      # 5Ô∏è‚É£ Crear t√∫nel i mostrar URL p√∫blica
      
name: Start Ngrok tunnel
      run: |
        ngrok http 8080 --log=stdout > ngrok.log &
        sleep 5

          NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | \
                       grep -oP '"public_url":"\Khttps://[^"]+')

          echo "üåê URL p√∫blica del FrontEnd: $NGROK_URL"
          echo "::notice title=URL::$NGROK_URL"

          # Mant√© el projecte obert 10 minuts
          sleep 600

      # 6Ô∏è‚É£ Neteja
      
name: Stop Docker containers
      if: always()
      run: docker compose down
