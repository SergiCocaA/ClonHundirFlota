name: Desplegament Hundir la Flota  # Nom del workflow: visible a Actions tab

on:
  push:
    branches: [ main ]  # S'activa en push a main; pots canviar a workflow_dispatch per manual
  workflow_dispatch:   # Permet executar manualment des de GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest  # Runner: Ubuntu per Docker suport

    steps:
    - name: Checkout code  # Pas 1: Clona el repo al runner
      uses: actions/checkout@v4  # Acci√≥ oficial GitHub per baixar el codi

    - name: Set up Docker Buildx  # Pas 2: Configura Docker per build multi-plat (essencial per compose)
      uses: docker/setup-buildx-action@v3  # Acci√≥ oficial per estendre Docker

    - name: Build and start containers  # Pas 3: Build i arrenca els 2 contenidors amb docker-compose
      run: |
        # Crea xarxa per compose
        docker network create hundir-network
        # Build imatges (backend custom, frontend usa nginx:stable)
        docker-compose build --no-cache
        # Arran√ßa en background (detached) i exposa ports: frontend a 8080, backend a 3000
        docker-compose up -d
        # Espera que estiguin sans (healthcheck del compose)
        sleep 30  # Petit delay per startup
        docker-compose ps  # Log per veure status

    - name: Install and auth Ngrok  # Pas 4: Instal¬∑la Ngrok i autentica amb token secret
      run: |
        # Descarrega binari Ngrok (versi√≥ estable)
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin/
        # Autentica amb el secret del repo
        ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}

    - name: Create Ngrok tunnel  # Pas 5: Crea t√∫nel HTTP al frontend (port 8080) per visualitzar des de fora
      run: |
        # Arran√ßa t√∫nel en background i captura URL p√∫blica
        ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
        NGROK_PID=$!
        # Espera uns segons per inicialitzar
        sleep 10
        # Extreu l'URL p√∫blica[](https://random.ngrok.io) i imprimeix-la als logs (profe la veur√†)
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "üåê Frontend accessible at: $PUBLIC_URL"
        echo "üîó Backend internal: http://localhost:3000 (via compose)"
        # Mata el proc√©s Ngrok al final d'aquest pas? No, continua al seg√ºent

    - name: Keep alive for 10 minutes  # Pas 6: Mant√© el desplegament viu 10 min (600s) per testing
      run: |
        echo "üöÄ Desplegament actiu! Esperant 10 minuts..."
        sleep 600  # 10 min exactes; durant aix√≤, el profe pot accedir via URL Ngrok
        # Opcional: Logs finals
        docker-compose logs --tail=10

    - name: Cleanup  # Pas 7: Neteja al final (borra contenidors per no gastar recursos del runner)
      if: always()  # S'executa sempre, encara que falli
      run: |
        docker-compose down -v --remove-orphans
        docker network rm hundir-network || true
        pkill ngrok || true  # Mata Ngrok si corre
