name: Desplegament Hundir la Flota  # Nom del workflow: visible a Actions tab

on:
  push:
    branches: [ main ]  # S'activa en push a main; pots canviar a workflow_dispatch per manual
  workflow_dispatch:   # Permet executar manualment des de GitHub UI (clica "Run workflow")

jobs:
  deploy:
    runs-on: ubuntu-latest  # Runner: Ubuntu per Docker suport (gratis, amb Docker preinstalat)

    steps:
    - name: Checkout code  # Pas 1: Clona tot el repo al runner (codi, Dockerfiles, compose)
      uses: actions/checkout@v4  # Acci√≥ oficial GitHub per baixar el codi fresc

    - name: Set up Docker Buildx  # Pas 2: Configura Docker Buildx per builds r√†pids i multi-plat (millor per compose)
      uses: docker/setup-buildx-action@v3  # Ext√©n Docker amb Buildx per cache i paral¬∑lelisme

    - name: Install dependencies  # Pas 3: Instal¬∑la eines extra (jq per JSON, curl per API; evita errors "command not found")
      run: |
        sudo apt update
        sudo apt install -y jq curl wget  # jq: parseja JSON de Ngrok; curl/wget: peticions web
        # Chequea Docker i Compose v2 (per logs)
        docker --version
        docker compose version  # Confirma v2 est√† OK

    - name: Build and start containers  # Pas 4: Build i arrenca els 2 contenidors (frontend Nginx + backend FastAPI)
      run: |
        # Crea xarxa personalitzada per comunicaci√≥ interna (frontend ‚Üí backend)
        docker network create hundir-network || true  # || true: ignora si ja existeix
        # Build imatges: backend des de Dockerfile (Python/FastAPI), frontend usa nginx:stable
        docker compose build --no-cache  # --no-cache: rebuild fresc, evita caches vells (nota: sense gui√≥n!)
        # Arran√ßa en background (detached mode) amb ports exposats
        docker compose up -d  # -d: detached, no bloqueja (sense gui√≥n!)
        # Espera startup (FastAPI pot tardar) i chequea health
        sleep 30  # Delay inicial
        docker compose ps  # Log status dels contenidors (sense gui√≥n!)
        # Test health: ping al backend (ajusta /health si el teu endpoint √©s diferent)
        curl -f http://localhost:3000/health || echo "Healthcheck OK si 200, ignora si no tens endpoint"

    - name: Install and auth Ngrok  # Pas 5: Descarrega i autentica Ngrok per t√∫nel segur (HTTPS extern)
      run: |
        # Descarrega binari Ngrok v3 (estable per Linux AMD64)
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin/  # Mou a PATH global
        # Autentica amb secret del repo (sense expondre-lo als logs)
        ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}  # Falla si no tens el secret!

    - name: Create Ngrok tunnel  # Pas 6: Crea t√∫nel HTTP al frontend (port 8080) i extreu URL p√∫blica
      run: |
        # Arran√ßa servidor Ngrok en background (t√∫nel al 8080 del frontend)
        nohup ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
        NGROK_PID=$!  # Guarda PID per matar despr√©s
        sleep 10  # Espera inicialitzaci√≥ (Ngrok API a :4040)
        # Obt√© URL p√∫blica via API local de Ngrok (parseja amb jq)
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url // empty')
        if [ -z "$PUBLIC_URL" ]; then
          echo "‚ùå Error: No Ngrok URL. Chequea logs: $(cat ngrok.log | tail -5)"
          exit 1
        fi
        echo "üåê Frontend accessible at: $PUBLIC_URL"  # Profe veu aix√≤ als logs!
        echo "üîó Backend internal (per debug): http://localhost:3000"
        echo "üïê T√∫nel actiu per 10 min..."  # Recordatori

    - name: Keep alive for 10 minutes  # Pas 7: Mant√© tot viu 10 min (600s) per testing (profe accedeix via URL)
      run: |
        echo "üöÄ Desplegament actiu! Profe, obre la URL Ngrok ara i juga 10 min."
        sleep 600  # Exactament 10 min; durant aix√≤, contenidors + t√∫nel corren
        # Logs finals per debug
        docker compose logs --tail=20 backend  # √öltims logs del backend (FastAPI errors?) (sense gui√≥n!)
        docker compose logs --tail=10 frontend  # Nginx logs (sense gui√≥n!)

    - name: Cleanup  # Pas 8: Neteja autom√†tica (allibera recursos del runner; sempre s'executa)
      if: always()  # S'executa encara que falli (important per no deixar "fantasmes")
      run: |
        # Para i borra contenidors/volums/xarxes
        docker compose down -v --remove-orphans --rmi local  # -v: vols, --rmi: imatges locals (sense gui√≥n!)
        docker network rm hundir-network || true
        # Mata Ngrok
        kill $NGROK_PID || pkill ngrok || true
        rm -f ngrok*  # Neteja fitxers temp
        echo "üßπ Cleanup fet. Ready per next run!"
